<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Home Guide Prototype (Elder / Family)</title>
  <style>
    :root { --bg:#0bbf63; --fg:#fff; --muted: rgba(255,255,255,.78); }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC","Segoe UI",Roboto,Arial,sans-serif; background: var(--bg); color: var(--fg); }
    .wrap { min-height:100vh; display:flex; flex-direction:column; padding:16px; gap:12px; box-sizing:border-box; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pill { background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.25); padding:8px 12px; border-radius:999px; font-size:14px; }
    .warn { background:rgba(255,179,0,.18); border-color:rgba(255,179,0,.6); }
    .danger { background:rgba(255,0,0,.16); border-color:rgba(255,0,0,.6); }

    .btn {
      background: rgba(255,255,255,.18);
      border:2px solid rgba(255,255,255,.35);
      color:var(--fg);
      border-radius:18px;
      padding:12px 14px;
      font-size:16px;
      font-weight:900;
    }
    .btnPrimary { background:rgba(255,255,255,.92); color:#0a7a43; border-color: rgba(255,255,255,.92); }
    .btnDanger  { background:rgba(255,255,255,.92); color:#b00020; border-color: rgba(255,255,255,.92); }

    .center { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    .title { font-size:20px; font-weight:950; letter-spacing:.3px; text-align:center; }
    .subtitle { font-size:14px; font-weight:800; color: var(--muted); text-align:center; }

    .arrowBox { width:min(78vw,360px); height:min(78vw,360px); display:flex; align-items:center; justify-content:center; }
    #arrowWrap { width:90%; height:90%; transform-origin:50% 75%; filter:drop-shadow(0 14px 20px rgba(0,0,0,.18)); }

    .distance { font-size:56px; font-weight:980; line-height:1; text-align:center; }
    .sub { font-size:26px; font-weight:950; text-align:center; }
    .hint { font-size:18px; font-weight:900; color:var(--muted); text-align:center; }

    .row { display:flex; gap:10px; width:100%; }
    .row .btn { flex:1; }

    .panel {
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.25);
      border-radius:16px;
      padding:12px;
      box-sizing:border-box;
    }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label { font-size:13px; font-weight:900; color: rgba(255,255,255,.92); }
    .field input, .field textarea {
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      border:1px solid rgba(255,255,255,.25);
      outline:none;
    }
    .field textarea { min-height: 74px; resize: vertical; }
    .hint2 { font-size:12px; color:rgba(255,255,255,.75); line-height:1.4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .hidden { display:none !important; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===== TOP BAR ===== -->
  <div class="top">
    <button class="btn" id="btnBack">â¬… è¿”å›</button>
    <div class="pill" id="status">è«‹é¸æ¨¡å¼</div>
    <button class="btn" id="btnMute">èªéŸ³ï¼šé–‹</button>
  </div>

  <!-- ===== HOME (MODE SELECT) ===== -->
  <div class="center" id="screenHome">
    <div class="title">å›å®¶å¼•å°ï¼ˆç¶²é åŸå‹ï¼‰</div>
    <div class="subtitle">é¸æ“‡å…¥å£ï¼šè€äººä½¿ç”¨ / å®¶äººè¨­å®š</div>

    <div class="row" style="max-width:520px;">
      <button class="btn btnPrimary" id="goElder" style="font-size:22px; padding:18px 16px;">ğŸ‘´ è€äººæ¨¡å¼</button>
    </div>

    <div class="row" style="max-width:520px;">
      <button class="btn" id="goFamily" style="font-size:22px; padding:18px 16px;">ğŸ‘ª å®¶äººæ¨¡å¼</button>
    </div>

    <div class="panel" style="max-width:520px;">
      <div class="hint2">
        âœ… å»ºè­°æµç¨‹ï¼šå…ˆé€²ã€Œå®¶äººæ¨¡å¼ã€è¨­å®šä½å®¶ä½ç½®èˆ‡é›»è©± â†’ ç”¢ç”Ÿåˆ†äº«é€£çµ â†’ å‚³çµ¦çˆ¸çˆ¸ â†’ çˆ¸çˆ¸é»é€£çµå°±ç›´æ¥é€²è€äººæ¨¡å¼ã€‚
      </div>
    </div>
  </div>

  <!-- ===== ELDER MODE ===== -->
  <div class="center hidden" id="screenElder">
    <div class="title">è€äººæ¨¡å¼</div>
    <div class="subtitle">åªçœ‹ç®­é ­èµ°ï¼Œèµ°åäº†æœƒæé†’ä½ </div>

    <div class="arrowBox">
      <div id="arrowWrap" aria-label="direction arrow">
        <!-- å¸¶å°¾å·´ç®­é ­ï¼šè·¯é¢æ¼†ç®­é ­æ„Ÿ -->
        <svg viewBox="0 0 200 200" width="100%" height="100%">
          <rect x="88" y="60" width="24" height="95" rx="10" fill="rgba(255,255,255,.97)"></rect>
          <path d="M100 22 L145 72 Q150 77 142 77 L118 77 L118 92 Q118 100 110 100 L90 100 Q82 100 82 92 L82 77 L58 77 Q50 77 55 72 Z"
                fill="rgba(255,255,255,.99)"></path>
          <rect x="97" y="78" width="6" height="70" rx="3" fill="rgba(11,191,99,.35)"></rect>
        </svg>
      </div>
    </div>

    <div class="distance" id="distText">-- å…¬å°º</div>
    <div class="sub" id="dirText">è«‹æŒ‰ã€ŒğŸ  å›å®¶ã€</div>
    <div class="hint" id="hintText">éœ€è¦è½‰å½æˆ–èµ°åæ‰æœƒèªªè©±</div>

    <div class="row" style="max-width:520px;">
      <button class="btn btnPrimary" id="btnStart" style="font-size:22px; padding:16px 16px;">ğŸ  å›å®¶</button>
      <button class="btn btnDanger" id="btnSOS" style="font-size:22px; padding:16px 16px;">ğŸ†˜ æ±‚åŠ©</button>
    </div>

    <div class="row" style="max-width:520px;">
      <button class="btn" id="btnPerm" style="padding:14px 14px;">å…è¨±æ„Ÿæ¸¬</button>
      <button class="btn" id="btnReRoute" style="padding:14px 14px;">â†» é‡è¦åŠƒ</button>
    </div>

    <div class="pill mono" id="dbg" style="max-width:520px; text-align:center;">GPS: -- | Heading: -- | Route: --</div>
  </div>

  <!-- ===== FAMILY MODE ===== -->
  <div class="center hidden" id="screenFamily" style="align-items:stretch;">
    <div class="title" style="text-align:center;">å®¶äººæ¨¡å¼ï¼ˆè¨­å®šï¼‰</div>
    <div class="subtitle">è¨­å®šä½å®¶ä½ç½®ã€é›»è©±ï¼Œä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµçµ¦é•·è¼©</div>

    <div class="panel" style="max-width:680px; margin:0 auto;">
      <div class="field">
        <label>å®¶äººé›»è©±ï¼ˆğŸ†˜ æ±‚åŠ©ç”¨ï¼‰</label>
        <input id="familyPhone" placeholder="ä¾‹å¦‚ï¼š0912345678" />
        <div class="hint2">é•·è¼©æŒ‰ ğŸ†˜ æœƒç›´æ¥æ’¥æ‰“æ­¤é›»è©±ã€‚</div>
      </div>

      <div class="field">
        <label>ä½å®¶ç·¯åº¦ï¼ˆLatï¼‰</label>
        <input id="homeLat" placeholder="ä¾‹å¦‚ï¼š25.052345" />
      </div>

      <div class="field">
        <label>ä½å®¶ç¶“åº¦ï¼ˆLngï¼‰</label>
        <input id="homeLng" placeholder="ä¾‹å¦‚ï¼š121.612345" />
        <div class="hint2">å»ºè­°ç”¨ Google Maps é•·æŒ‰å®¶é–€å£å–å¾—åº§æ¨™ï¼ˆæœ€æº–ï¼‰ã€‚</div>
      </div>

      <div class="row">
        <button class="btn btnPrimary" id="btnSave">å„²å­˜è¨­å®š</button>
        <button class="btn" id="btnPreviewElder">ç”¨æœ¬æ©Ÿé€²è€äººæ¨¡å¼æ¸¬è©¦</button>
      </div>
    </div>

    <div class="panel" style="max-width:680px; margin:0 auto;">
      <div class="field">
        <label>åˆ†äº«çµ¦é•·è¼©çš„é€£çµï¼ˆé»é–‹ç›´æ¥é€²è€äººæ¨¡å¼ï¼‰</label>
        <textarea id="shareLink" class="mono" readonly></textarea>
        <div class="hint2">
          ä½ å¯ä»¥æŠŠé€™å€‹é€£çµè²¼åˆ° LINE / WhatsApp çµ¦çˆ¸çˆ¸ã€‚<br>
          é€£çµæœƒå¸¶å…¥ï¼šä½å®¶åº§æ¨™ã€é›»è©±ã€ä»¥åŠå¯é¸çš„ã€Œè‡ªå‹•é–‹å§‹ã€ã€‚
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnCopy">è¤‡è£½é€£çµ</button>
        <button class="btn" id="btnToggleAuto">è‡ªå‹•é–‹å§‹ï¼šé–‹</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ===================== Settings ===================== */
const STORE_KEY = "home_guide_settings_v2";
function loadSettings(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return { familyPhone:"", home:{lat:null,lng:null}, autoStart:true };
    const s = JSON.parse(raw);
    return {
      familyPhone: s.familyPhone || "",
      home: s.home || {lat:null,lng:null},
      autoStart: (typeof s.autoStart === "boolean") ? s.autoStart : true
    };
  }catch(e){
    return { familyPhone:"", home:{lat:null,lng:null}, autoStart:true };
  }
}
function saveSettings(s){
  localStorage.setItem(STORE_KEY, JSON.stringify(s));
}

let settings = loadSettings();

/* ===================== Helpers ===================== */
const $ = (id)=>document.getElementById(id);
function toRad(d){ return d * Math.PI / 180; }
function toDeg(r){ return r * 180 / Math.PI; }
function normRel(a){ let x = ((a + 180) % 360) - 180; return x; }

function distanceMeters(a, b){
  const R=6371000;
  const dLat = toRad(b.lat-a.lat);
  const dLng = toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const aa=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  const c=2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
  return R*c;
}
function bearingDeg(a, b){
  const Ï†1=toRad(a.lat), Ï†2=toRad(b.lat);
  const Î»1=toRad(a.lng), Î»2=toRad(b.lng);
  const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
  const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
  let Î¸=toDeg(Math.atan2(y,x));
  return (Î¸+360)%360;
}
function setStatus(text, type=""){
  $("status").textContent = text;
  $("status").className = "pill " + (type||"");
}
function rotateArrow(deg){
  $("arrowWrap").style.transform = `rotate(${deg}deg)`;
}
function vibrate(pattern){
  if(navigator.vibrate) navigator.vibrate(pattern);
}

/* ===================== Speech ===================== */
let mute=false;
let lastSpeakAt=0;
function speak(text, urgent=false){
  if(mute) return;
  const now=Date.now();
  const cooldown = urgent ? 2500 : 9000;
  if(now-lastSpeakAt < cooldown) return;
  lastSpeakAt = now;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang="zh-TW";
    u.rate=0.95;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}
$("btnMute").onclick=()=>{
  mute=!mute;
  $("btnMute").textContent = `èªéŸ³ï¼š${mute ? "é—œ" : "é–‹"}`;
  if(!mute) speak("èªéŸ³å·²é–‹å•Ÿ", true);
};

/* ===================== Simple Route (OSRM) ===================== */
let route=null; // { line, steps, nextIdx }
async function fetchRoute(from, to){
  const url = `https://router.project-osrm.org/route/v1/walking/${from.lng},${from.lat};${to.lng},${to.lat}?steps=true&geometries=geojson&overview=full`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("route fetch failed");
  const data = await r.json();
  const rt = data.routes?.[0];
  if(!rt) throw new Error("no route");
  const legs = rt.legs?.[0];
  const steps = legs?.steps || [];
  const line = rt.geometry?.coordinates || [];
  return { line, steps, nextIdx: 0 };
}
function getNextManeuverTarget(rt){
  if(!rt?.steps?.length) return null;
  const idx = Math.min(rt.nextIdx, rt.steps.length-1);
  const st = rt.steps[idx];
  const loc = st.maneuver?.location;
  const mod = st.maneuver?.modifier || "";
  if(!loc) return null;
  return { lng: loc[0], lat: loc[1], mod };
}
function friendlyTurnText(mod){
  if(mod.includes("left")) return "ç­‰ä¸€ä¸‹å·¦è½‰";
  if(mod.includes("right")) return "ç­‰ä¸€ä¸‹å³è½‰";
  return "ç­‰ä¸€ä¸‹ç›´èµ°";
}
function metersToPolyline(point, lineLngLat){
  const lat0 = toRad(point.lat);
  const cos0 = Math.cos(lat0);
  const R = 6371000;

  function proj(p){
    const x = toRad(p[0]) * cos0 * R;
    const y = toRad(p[1]) * R;
    return {x,y};
  }
  const P = { x: toRad(point.lng)*cos0*R, y: toRad(point.lat)*R };

  let min = Infinity;
  for(let i=0;i<lineLngLat.length-1;i++){
    const A0 = proj(lineLngLat[i]);
    const B0 = proj(lineLngLat[i+1]);
    const vx = B0.x - A0.x, vy = B0.y - A0.y;
    const wx = P.x - A0.x, wy = P.y - A0.y;
    const c1 = vx*wx + vy*wy;
    const c2 = vx*vx + vy*vy;
    let t = c2 === 0 ? 0 : (c1 / c2);
    t = Math.max(0, Math.min(1, t));
    const px = A0.x + t*vx, py = A0.y + t*vy;
    const dx = P.x - px, dy = P.y - py;
    const d = Math.sqrt(dx*dx + dy*dy);
    if(d < min) min = d;
  }
  return min;
}
function offRouteMessage(){
  const msgs = [
    "æˆ‘å€‘èµ°åäº†ï¼Œè«‹çœ‹ç®­é ­ã€‚",
    "å¥½åƒèµ°éé ­äº†ï¼Œæˆ‘å€‘å›é ­ä¸€é»ã€‚",
    "å…ˆåœä¸€ä¸‹ï¼Œçœ‹ç®­é ­å†èµ°ã€‚"
  ];
  return msgs[Math.floor(Math.random()*msgs.length)];
}

/* ===================== Navigation State ===================== */
let deviceHeading=null;
let currPos=null;
let watchId=null;
let offRouteCount=0;
let lastReRouteAt=0;

function updateElderUI(){
  const home = settings.home;

  if(!home?.lat || !home?.lng){
    setStatus("è«‹å…ˆè¨­å®šä½å®¶ä½ç½®", "warn");
    $("dirText").textContent = "è«‹è«‹å®¶äººå…ˆè¨­å®š";
    $("distText").textContent = "-- å…¬å°º";
    $("hintText").textContent = "å›åˆ°é¦–é  â†’ å®¶äººæ¨¡å¼è¨­å®š";
    $("dbg").textContent = `GPS: -- | Heading: ${deviceHeading==null?"--":Math.round(deviceHeading)+"Â°"} | Route: --`;
    return;
  }

  if(!currPos){
    setStatus("å®šä½ä¸­...ï¼ˆè«‹åˆ°æˆ¶å¤–ï¼‰", "warn");
    $("dirText").textContent = "æ­£åœ¨å®šä½";
    $("distText").textContent = "-- å…¬å°º";
    $("hintText").textContent = "è‹¥è¶…é 30 ç§’ï¼šè«‹åˆ°æˆ¶å¤–ã€é–‹å•Ÿç²¾ç¢ºä½ç½®";
    $("dbg").textContent = `GPS: -- | Heading: ${deviceHeading==null?"--":Math.round(deviceHeading)+"Â°"} | Route: ${route ? "OK" : "--"}`;
    return;
  }

  const distHome = Math.round(distanceMeters(currPos, home));
  $("distText").textContent = `${distHome} å…¬å°º`;

  let target = route ? getNextManeuverTarget(route) : null;

  if(target){
    const distToTurn = Math.round(distanceMeters(currPos, {lat:target.lat, lng:target.lng}));

    if(distToTurn <= 25){
      const say = friendlyTurnText(target.mod);
      $("dirText").textContent = say.replace("ç­‰ä¸€ä¸‹","");
      speak(say, true);
    }else{
      $("dirText").textContent = "è·Ÿè‘—ç®­é ­èµ°";
    }

    const br = bearingDeg(currPos, {lat:target.lat, lng:target.lng});
    if(deviceHeading != null){
      rotateArrow(normRel(br - deviceHeading));
    }else{
      rotateArrow(br);
    }

    if(distToTurn <= 10 && route.nextIdx < route.steps.length-1){
      route.nextIdx += 1;
    }

    $("hintText").textContent = `ä¸‹ä¸€å€‹ç¯€é»ç´„ ${distToTurn} å…¬å°º`;
  }else{
    const br = bearingDeg(currPos, home);
    if(deviceHeading != null){
      rotateArrow(normRel(br - deviceHeading));
    }else{
      rotateArrow(br);
    }
    $("dirText").textContent = "è«‹æœç®­é ­èµ°";
    $("hintText").textContent = "ï¼ˆå°šæœªå–å¾—è·¯ç·šï¼‰";
  }

  if(route?.line?.length){
    const dLine = metersToPolyline(currPos, route.line);
    if(dLine > 25) offRouteCount += 1;
    else offRouteCount = Math.max(0, offRouteCount-1);

    if(offRouteCount >= 3){
      setStatus("åé›¢è·¯ç·š", "warn");
      vibrate([200,100,200,100,300]);
      speak(offRouteMessage(), true);
      offRouteCount = 0;

      const now = Date.now();
      if(now - lastReRouteAt > 15000){
        lastReRouteAt = now;
        reRoute(true);
      }
    }else{
      setStatus("æ­£åœ¨å¼•å°å›å®¶");
    }
  }else{
    setStatus("æ­£åœ¨å¼•å°å›å®¶");
  }

  $("dbg").textContent = `GPS: ${currPos.lat.toFixed(5)},${currPos.lng.toFixed(5)} | Heading: ${deviceHeading==null?"--":Math.round(deviceHeading)+"Â°"} | Route: ${route ? "OK" : "--"}`;
}

/* ===================== âœ… å¿…ä¿®è£œä¸ï¼šstartWatch ===================== */
function startWatch(){
  if(!navigator.geolocation){
    setStatus("ä¸æ”¯æ´å®šä½", "danger");
    alert("æ­¤è£ç½®ä¸æ”¯æ´å®šä½");
    return;
  }

  setStatus("å®šä½ä¸­...ï¼ˆè«‹åˆ°æˆ¶å¤–ï¼‰", "warn");
  $("dirText").textContent = "æ­£åœ¨å®šä½";
  $("hintText").textContent = "å¦‚æœè¶…é 30 ç§’ï¼Œè«‹åˆ°æˆ¶å¤–æˆ–é–‹å•Ÿç²¾ç¢ºä½ç½®";

  // å…ˆæŠ“ä¸€æ¬¡ç•¶ä¸‹å®šä½ï¼ˆæ›´å®¹æ˜“æ‹¿åˆ°ç¬¬ä¸€é»ï¼‰
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      currPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      setStatus("å·²å–å¾—å®šä½");
      updateElderUI();
      beginWatch(); // å–å¾—ç¬¬ä¸€é»å¾Œå†é–‹å§‹ watch
      // ç¬¬ä¸€é»åˆ°æ‰‹å¾Œï¼Œé †ä¾¿æŠ“è·¯ç·š
      setTimeout(()=>reRoute(true), 600);
    },
    (err)=>{
      const msg =
        err.code === 1 ? "å®šä½è¢«æ‹’çµ•ï¼ˆè«‹å…è¨±ä½ç½®æ¬Šé™ï¼‰" :
        err.code === 2 ? "ç„¡æ³•å–å¾—å®šä½ï¼ˆè«‹åˆ°æˆ¶å¤–/é–‹ç²¾ç¢ºä½ç½®ï¼‰" :
        "å®šä½é€¾æ™‚ï¼ˆè«‹åˆ°æˆ¶å¤–/ç¨å¾Œå†è©¦ï¼‰";
      setStatus(msg, "danger");
      $("dirText").textContent = "ç„¡æ³•å®šä½";
      $("hintText").textContent = "è«‹æª¢æŸ¥ï¼šå®šä½æ¬Šé™ã€ç²¾ç¢ºä½ç½®ã€æˆ¶å¤–ç©ºæ› è™•";
      alert(msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );

  function beginWatch(){
    if(watchId != null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      (pos)=>{
        currPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        setStatus("æ­£åœ¨å¼•å°å›å®¶");
        updateElderUI();
      },
      (err)=>{
        const msg =
          err.code === 1 ? "å®šä½è¢«æ‹’çµ•ï¼ˆè«‹å…è¨±ä½ç½®æ¬Šé™ï¼‰" :
          err.code === 2 ? "ç„¡æ³•å–å¾—å®šä½ï¼ˆè«‹åˆ°æˆ¶å¤–/é–‹ç²¾ç¢ºä½ç½®ï¼‰" :
          "å®šä½é€¾æ™‚ï¼ˆè«‹ç¨å¾Œå†è©¦ï¼‰";
        setStatus(msg, "danger");
      },
      { enableHighAccuracy: true, maximumAge: 800, timeout: 20000 }
    );

    // 30ç§’ä¿éšªï¼šä»æ²’æ‹¿åˆ°é»å°±æé†’
    setTimeout(()=>{
      if(!currPos){
        setStatus("ä»åœ¨å®šä½ä¸­ï¼ˆå»ºè­°åˆ°æˆ¶å¤–ï¼‰", "warn");
        $("hintText").textContent = "è‹¥ä¸€ç›´å¡ä½ï¼šé–‹å•Ÿç²¾ç¢ºä½ç½®ã€é—œä½è€—é›»ã€æ›æˆ¶å¤–";
      }
    }, 30000);
  }
}

/* ===================== ReRoute ===================== */
async function reRoute(silent=false){
  const home = settings.home;
  if(!currPos || !home?.lat || !home?.lng){
    if(!silent) alert("è«‹å…ˆå–å¾—å®šä½ä¸¦è¨­å®šä½å®¶ä½ç½®");
    return;
  }
  try{
    setStatus("è·¯ç·šè¦åŠƒä¸­...");
    route = await fetchRoute(currPos, home);
    route.nextIdx = 0;
    setStatus("æ­£åœ¨å¼•å°å›å®¶");
    if(!silent) speak("å·²æ›´æ–°è·¯ç·š", true);
    updateElderUI();
  }catch(e){
    setStatus("è·¯ç·šå¤±æ•—", "danger");
    if(!silent) alert("è·¯ç·šå–å¾—å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ–æœå‹™é™åˆ¶ï¼‰");
  }
}

/* ===================== Motion Permission ===================== */
$("btnPerm").onclick = async ()=>{
  try{
    if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function"){
      const res = await DeviceOrientationEvent.requestPermission();
      if(res !== "granted") throw new Error("not granted");
    }
    setStatus("æ„Ÿæ¸¬å¯ç”¨");
  }catch(e){
    setStatus("æ„Ÿæ¸¬æœªå…è¨±", "warn");
    alert("è«‹å…è¨±ã€å‹•ä½œèˆ‡æ–¹å‘ã€ï¼Œç®­é ­æœƒæ›´æº–ã€‚");
  }
};
window.addEventListener("deviceorientation",(e)=>{
  if(typeof e.webkitCompassHeading === "number"){
    deviceHeading = e.webkitCompassHeading;
  }else if(typeof e.alpha === "number"){
    deviceHeading = (360 - e.alpha) % 360;
  }
}, true);

/* ===================== SOS ===================== */
function getMapsLink(pos){ return `https://www.google.com/maps?q=${pos.lat},${pos.lng}`; }
$("btnSOS").onclick = ()=>{
  const phone = (settings.familyPhone||"").trim();
  if(phone) window.location.href = `tel:${phone}`;

  if(currPos){
    const msg = `æˆ‘éœ€è¦å”åŠ©ï¼Œæˆ‘çš„ä½ç½®ï¼š${getMapsLink(currPos)}`;
    const smsUrl = phone ? `sms:${phone}?&body=${encodeURIComponent(msg)}` : `sms:?&body=${encodeURIComponent(msg)}`;
    window.open(smsUrl, "_blank");
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
  }
};

/* ===================== Screens ===================== */
function show(screen){
  $("screenHome").classList.add("hidden");
  $("screenElder").classList.add("hidden");
  $("screenFamily").classList.add("hidden");
  screen.classList.remove("hidden");
}

$("btnBack").onclick = ()=>{
  show($("screenHome"));
  setStatus("è«‹é¸æ¨¡å¼");
};

$("goElder").onclick = ()=>{
  show($("screenElder"));
  setStatus("è€äººæ¨¡å¼");
  updateElderUI();
};

$("goFamily").onclick = ()=>{
  show($("screenFamily"));
  setStatus("å®¶äººæ¨¡å¼");
  fillFamilyForm();
  updateShareLink();
};

/* ===================== Family Mode ===================== */
function fillFamilyForm(){
  $("familyPhone").value = settings.familyPhone || "";
  $("homeLat").value = settings.home?.lat ?? "";
  $("homeLng").value = settings.home?.lng ?? "";
  $("btnToggleAuto").textContent = `è‡ªå‹•é–‹å§‹ï¼š${settings.autoStart ? "é–‹" : "é—œ"}`;
}

function updateShareLink(){
  const base = `${location.origin}${location.pathname}`;
  const lat = $("homeLat").value.trim();
  const lng = $("homeLng").value.trim();
  const phone = $("familyPhone").value.trim();
  const auto = settings.autoStart ? "1" : "0";

  const params = new URLSearchParams();
  params.set("mode", "elder");
  if(lat) params.set("homeLat", lat);
  if(lng) params.set("homeLng", lng);
  if(phone) params.set("phone", phone);
  params.set("autostart", auto);

  $("shareLink").value = `${base}?${params.toString()}`;
}

$("btnSave").onclick = ()=>{
  const phone = $("familyPhone").value.trim();
  const lat = parseFloat($("homeLat").value);
  const lng = parseFloat($("homeLng").value);

  if(!isFinite(lat) || !isFinite(lng)){
    alert("è«‹å¡«å…¥ä½å®¶ç¶“ç·¯åº¦ï¼ˆLat/Lngï¼‰");
    return;
  }

  settings = {
    ...settings,
    familyPhone: phone,
    home: { lat, lng }
  };
  saveSettings(settings);
  setStatus("å·²å„²å­˜è¨­å®š");
  updateShareLink();
  alert("å·²å„²å­˜ï¼ˆå¯è¤‡è£½åˆ†äº«é€£çµçµ¦é•·è¼©ï¼‰");
};

$("btnPreviewElder").onclick = ()=>{
  show($("screenElder"));
  setStatus("è€äººæ¨¡å¼");
  updateElderUI();
};

$("familyPhone").addEventListener("input", updateShareLink);
$("homeLat").addEventListener("input", updateShareLink);
$("homeLng").addEventListener("input", updateShareLink);

$("btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($("shareLink").value);
    alert("å·²è¤‡è£½é€£çµ");
  }catch(e){
    $("shareLink").focus();
    $("shareLink").select();
    alert("è«‹æ‰‹å‹•è¤‡è£½ï¼ˆå·²é¸å–æ–‡å­—ï¼‰");
  }
};

$("btnToggleAuto").onclick = ()=>{
  settings.autoStart = !settings.autoStart;
  saveSettings(settings);
  $("btnToggleAuto").textContent = `è‡ªå‹•é–‹å§‹ï¼š${settings.autoStart ? "é–‹" : "é—œ"}`;
  updateShareLink();
};

/* ===================== Start / ReRoute ===================== */
$("btnStart").onclick = ()=>{
  setStatus("é–‹å§‹å¼•å°");
  speak("é–‹å§‹å›å®¶", true);
  startWatch();
};
$("btnReRoute").onclick = ()=>reRoute(false);

/* ===================== Query Params (Share Link) ===================== */
function applyQuery(){
  const q = new URLSearchParams(location.search);
  const mode = q.get("mode");

  const homeLat = q.get("homeLat");
  const homeLng = q.get("homeLng");
  const phone   = q.get("phone");
  const auto    = q.get("autostart");

  let changed=false;
  if(homeLat && homeLng){
    const lat = parseFloat(homeLat), lng = parseFloat(homeLng);
    if(isFinite(lat) && isFinite(lng)){
      settings.home = {lat, lng};
      changed=true;
    }
  }
  if(phone != null){
    settings.familyPhone = phone;
    changed=true;
  }
  if(auto === "0" || auto === "1"){
    settings.autoStart = (auto === "1");
    changed=true;
  }
  if(changed) saveSettings(settings);

  if(mode === "elder"){
    show($("screenElder"));
    setStatus("è€äººæ¨¡å¼");
    updateElderUI();

    if(settings.autoStart){
      setTimeout(()=>{ $("btnStart").click(); }, 600);
    }
  }else if(mode === "family"){
    show($("screenFamily"));
    setStatus("å®¶äººæ¨¡å¼");
    fillFamilyForm();
    updateShareLink();
  }else{
    show($("screenHome"));
    setStatus("è«‹é¸æ¨¡å¼");
  }
}
applyQuery();
</script>

</body>
</html>
