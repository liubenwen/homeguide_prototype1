<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Home Guide Prototype (A+B)</title>
  <style>
    :root { --bg:#0bbf63; --fg:#fff; --muted: rgba(255,255,255,.78); }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC","Segoe UI",Roboto,Arial,sans-serif; background: var(--bg); color: var(--fg); }
    .wrap { min-height:100vh; display:flex; flex-direction:column; padding: 16px; box-sizing:border-box; gap: 12px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .pill { background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.25); padding: 8px 12px; border-radius: 999px; font-size: 14px; }
    .warn { background: rgba(255,179,0,.18); border-color: rgba(255,179,0,.6); }
    .danger { background: rgba(255,0,0,.16); border-color: rgba(255,0,0,.6); }

    .btn { background: rgba(255,255,255,.18); border:2px solid rgba(255,255,255,.35); color: var(--fg);
      border-radius: 18px; padding: 10px 14px; font-size: 16px; font-weight: 800; }
    .btnPrimary { background: rgba(255,255,255,.92); color:#0a7a43; border-color: rgba(255,255,255,.92); }
    .btnDanger { background: rgba(255,255,255,.92); color:#b00020; border-color: rgba(255,255,255,.92); }

    .center { flex: 1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap: 10px; }
    .title { font-size: 18px; font-weight: 900; opacity: .95; }
    .arrowBox { width:min(78vw, 360px); height:min(78vw, 360px); display:flex; align-items:center; justify-content:center; }
    /* SVGç®­é ­å®¹å™¨æ—‹è½‰ */
    #arrowWrap { width: 90%; height: 90%; transform-origin: 50% 75%; filter: drop-shadow(0 14px 20px rgba(0,0,0,.18)); }

    .distance { font-size: 58px; font-weight: 950; line-height: 1; text-align:center; }
    .sub { font-size: 26px; font-weight: 900; text-align:center; }
    .hint { font-size: 18px; font-weight: 800; color: var(--muted); text-align:center; padding: 0 10px; }

    .bottom { display:flex; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
    .row { display:flex; gap: 10px; width:100%; }
    .row .btn { flex: 1; }
    .mini { font-size: 13px; opacity:.9; }
    .panel {
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.25);
      border-radius: 16px;
      padding: 12px;
      box-sizing:border-box;
      display:none;
    }
    .panel h3 { margin: 0 0 10px 0; font-size: 16px; }
    .field { display:flex; flex-direction:column; gap: 6px; margin-bottom: 10px; }
    .field label { font-size: 13px; color: rgba(255,255,255,.9); font-weight: 800; }
    .field input {
      border-radius: 12px; border:1px solid rgba(255,255,255,.25);
      padding: 10px 12px; font-size: 16px; outline:none;
      background: rgba(255,255,255,.92); color:#0a2a1a; font-weight:700;
    }
    .field .hint2 { font-size: 12px; color: rgba(255,255,255,.75); }
    .split { display:flex; gap:10px; }
    .split > div { flex: 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button class="btn" id="btnPerm">å…è¨±æ„Ÿæ¸¬</button>
      <div class="pill" id="status">å°šæœªé–‹å§‹</div>
      <button class="btn" id="btnMute">èªéŸ³ï¼šé–‹</button>
    </div>

    <div class="center">
      <div class="title">å›å®¶å¼•å°ï¼ˆA+B åŸå‹ï¼‰</div>

      <div class="arrowBox">
        <div id="arrowWrap" aria-label="direction arrow">
          <!-- å¸¶å°¾å·´ç®­é ­ï¼šåƒè·¯é¢ç®­é ­ï¼ˆSVGï¼‰ -->
          <svg viewBox="0 0 200 200" width="100%" height="100%">
            <!-- å°¾å·´ -->
            <rect x="88" y="60" width="24" height="95" rx="10" fill="rgba(255,255,255,.95)"></rect>
            <!-- ç®­é ­é ­ -->
            <path d="M100 22 L145 72 Q150 77 142 77 L118 77 L118 92 Q118 100 110 100 L90 100 Q82 100 82 92 L82 77 L58 77 Q50 77 55 72 Z"
                  fill="rgba(255,255,255,.98)"></path>
            <!-- ä¸­ç·šï¼ˆè®“æ–¹å‘æ›´åƒé“è·¯ï¼‰ -->
            <rect x="97" y="78" width="6" height="70" rx="3" fill="rgba(11,191,99,.35)"></rect>
          </svg>
        </div>
      </div>

      <div class="distance" id="distText">-- å…¬å°º</div>
      <div class="sub" id="dirText">è«‹æŒ‰ã€ŒğŸ  å›å®¶ã€</div>
      <div class="hint" id="hintText">åªçœ‹ç®­é ­èµ°ã€‚å¿«åˆ°è½‰å½æ‰æœƒæé†’ã€‚</div>
    </div>

    <div class="bottom">
      <div class="row">
        <button class="btn btnPrimary" id="btnStart">ğŸ  å›å®¶</button>
        <button class="btn" id="btnSettings">âš™ï¸ è¨­å®š</button>
      </div>
      <div class="row">
        <button class="btn btnDanger" id="btnSOS">ğŸ†˜ æ±‚åŠ©</button>
        <button class="btn" id="btnReRoute">â†» é‡æ–°è¦åŠƒ</button>
      </div>
      <div class="pill mini" id="dbg">GPS: -- | Heading: -- | Route: --</div>

      <!-- è¨­å®šé¢æ¿ï¼ˆPINé–ï¼‰ -->
      <div class="panel" id="settingsPanel">
        <h3>è¨­å®šï¼ˆå®¶äººæ“ä½œï¼‰</h3>

        <div class="field">
          <label>PINï¼ˆ4ä½æ•¸ï¼‰</label>
          <input id="pinInput" inputmode="numeric" maxlength="4" placeholder="é è¨­ 1234" />
          <div class="hint2">ç”¨ä¾†ä¿è­·è¨­å®šï¼Œé¿å…èª¤æ”¹ã€‚ç¬¬ä¸€æ¬¡ä¸å¡«ï¼ç”¨é è¨­ã€‚</div>
        </div>

        <div class="field">
          <label>å®¶äººé›»è©±ï¼ˆæ±‚åŠ©ç”¨ï¼‰</label>
          <input id="familyPhone" placeholder="ä¾‹å¦‚ï¼š0912345678" />
          <div class="hint2">ğŸ†˜ æœƒç”¨ tel: æ’¥æ‰“ï¼ˆæ‰‹æ©Ÿç€è¦½å™¨å¯ç”¨ï¼‰ã€‚</div>
        </div>

        <div class="field">
          <label>ä½å®¶åœ°å€ï¼ˆå¯é¸ï¼ŒåŸå‹ç”¨ç·šä¸Šåœ°ç†ç·¨ç¢¼ï¼‰</label>
          <input id="homeAddr" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚å—æ¸¯å€å¸‚æ°‘å¤§é“å…«æ®µ369è™Ÿ" />
          <div class="hint2">åŸå‹ç”¨ OpenStreetMap Nominatimï¼ˆæœ‰ä½¿ç”¨é™åˆ¶ï¼‰ã€‚ä¹Ÿå¯ç›´æ¥å¡«ç¶“ç·¯åº¦æœ€ç©©ã€‚</div>
        </div>

        <div class="split">
          <div class="field">
            <label>ä½å®¶ç·¯åº¦ Lat</label>
            <input id="homeLat" placeholder="25.xxxxx" />
          </div>
          <div class="field">
            <label>ä½å®¶ç¶“åº¦ Lng</label>
            <input id="homeLng" placeholder="121.xxxxx" />
          </div>
        </div>

        <div class="row">
          <button class="btn btnPrimary" id="btnSaveSettings">å„²å­˜</button>
          <button class="btn" id="btnCloseSettings">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

<script>
/** ========== å„²å­˜/è¼‰å…¥è¨­å®š ========== */
const STORE_KEY = "home_guide_settings_v1";
const DEFAULT_PIN = "1234";

function loadSettings(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return { pin: DEFAULT_PIN, familyPhone:"", home:{lat:null,lng:null}, homeAddr:"" };
    const s = JSON.parse(raw);
    return {
      pin: s.pin || DEFAULT_PIN,
      familyPhone: s.familyPhone || "",
      home: s.home || {lat:null,lng:null},
      homeAddr: s.homeAddr || ""
    };
  }catch(e){
    return { pin: DEFAULT_PIN, familyPhone:"", home:{lat:null,lng:null}, homeAddr:"" };
  }
}
function saveSettings(s){
  localStorage.setItem(STORE_KEY, JSON.stringify(s));
}

let settings = loadSettings();

/** ========== UI elements ========== */
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
const distEl = $("distText");
const dirEl = $("dirText");
const hintEl = $("hintText");
const dbgEl = $("dbg");
const arrowWrap = $("arrowWrap");
const panel = $("settingsPanel");

/** ========== ç‹€æ…‹ ========== */
let mute = false;
let navOn = false;

let deviceHeading = null; // 0..360
let watchId = null;

let currPos = null; // {lat,lng}
let route = null;   // { line: [ [lng,lat], ... ], steps: [...], nextIdx }
let lastSpeakAt = 0;
let lastReRouteAt = 0;
let offRouteCount = 0;

/** ========== å·¥å…· ========== */
function toRad(d){ return d * Math.PI / 180; }
function toDeg(r){ return r * 180 / Math.PI; }
function normRel(a){ let x = ((a + 180) % 360) - 180; return x; }

function distanceMeters(a, b){
  const R=6371000;
  const dLat = toRad(b.lat-a.lat);
  const dLng = toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const aa=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  const c=2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
  return R*c;
}
function bearingDeg(a, b){
  const Ï†1=toRad(a.lat), Ï†2=toRad(b.lat);
  const Î»1=toRad(a.lng), Î»2=toRad(b.lng);
  const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
  const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
  let Î¸=toDeg(Math.atan2(y,x));
  return (Î¸+360)%360;
}
function setStatus(text, type=""){
  statusEl.textContent = text;
  statusEl.className = "pill " + (type||"");
}
function rotateArrow(deg){
  arrowWrap.style.transform = `rotate(${deg}deg)`;
}
function vibrate(pattern){
  if(navigator.vibrate) navigator.vibrate(pattern);
}
function speak(text, urgent=false){
  if(mute) return;
  const now=Date.now();
  const cooldown = urgent ? 2500 : 9000; // åªåœ¨å¿…è¦æ™‚èªªï¼Œå†·å»ä¹…ä¸€é»
  if(now-lastSpeakAt < cooldown) return;
  lastSpeakAt = now;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    u.rate = 0.95;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

/** ========== è·é›¢åˆ°è·¯ç·šï¼ˆç²—ä¼°ï¼ŒåŸå‹å¤ ç”¨ï¼‰ ========== */
function metersToPolyline(point, lineLngLat){
  // equirectangular projection around point for speed
  const lat0 = toRad(point.lat);
  const cos0 = Math.cos(lat0);
  const R = 6371000;

  function proj(p){ // p = [lng,lat]
    const x = toRad(p[0]) * cos0 * R;
    const y = toRad(p[1]) * R;
    return {x,y};
  }
  const P = { x: toRad(point.lng)*cos0*R, y: toRad(point.lat)*R };

  let min = Infinity;
  for(let i=0;i<lineLngLat.length-1;i++){
    const A0 = proj(lineLngLat[i]);
    const B0 = proj(lineLngLat[i+1]);
    const vx = B0.x - A0.x, vy = B0.y - A0.y;
    const wx = P.x - A0.x, wy = P.y - A0.y;
    const c1 = vx*wx + vy*wy;
    const c2 = vx*vx + vy*vy;
    let t = c2 === 0 ? 0 : (c1 / c2);
    t = Math.max(0, Math.min(1, t));
    const px = A0.x + t*vx, py = A0.y + t*vy;
    const dx = P.x - px, dy = P.y - py;
    const d = Math.sqrt(dx*dx + dy*dy);
    if(d < min) min = d;
  }
  return min;
}

/** ========== è·¯ç·šè¦åŠƒï¼ˆOSRM walkingï¼‰ ========== */
async function fetchRoute(from, to){
  // OSRM expects lon,lat
  const url = `https://router.project-osrm.org/route/v1/walking/${from.lng},${from.lat};${to.lng},${to.lat}?steps=true&geometries=geojson&overview=full`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("route fetch failed");
  const data = await r.json();
  const rt = data.routes?.[0];
  if(!rt) throw new Error("no route");
  const legs = rt.legs?.[0];
  const steps = legs?.steps || [];

  // line: GeoJSON coordinates [lng,lat]
  const line = rt.geometry?.coordinates || [];

  return { line, steps, nextIdx: 0 };
}

/** ========== æ‰¾ã€Œä¸‹ä¸€å€‹è½‰å½ç¯€é»ã€ ========== */
function getNextManeuverTarget(routeObj){
  if(!routeObj || !routeObj.steps?.length) return null;
  const idx = Math.min(routeObj.nextIdx, routeObj.steps.length-1);
  const st = routeObj.steps[idx];

  // OSRM step maneuver location: [lng,lat]
  const loc = st.maneuver?.location;
  const type = st.maneuver?.type || "";
  const mod  = st.maneuver?.modifier || ""; // left/right/straight/slight left...
  const name = st.name || "";

  if(!loc) return null;

  return { lng: loc[0], lat: loc[1], type, mod, name };
}

function friendlyTurnText(mod){
  // åªçµ¦ç°¡å–®è©ï¼Œä¸ç”¨â€œåå·¦åå³â€ä¹Ÿå¯ä»¥
  if(mod.includes("left")) return "ç­‰ä¸€ä¸‹å·¦è½‰";
  if(mod.includes("right")) return "ç­‰ä¸€ä¸‹å³è½‰";
  return "ç­‰ä¸€ä¸‹ç›´èµ°";
}
function offRouteMessage(){
  // ç°¡å–®ã€ä¸ä¸­å‚·
  const msgs = [
    "æˆ‘å€‘èµ°åäº†ï¼Œè«‹çœ‹ç®­é ­ã€‚",
    "å¥½åƒèµ°éé ­äº†ï¼Œæˆ‘å€‘å›é ­ä¸€é»ã€‚",
    "å…ˆåœä¸€ä¸‹ï¼Œçœ‹ç®­é ­å†èµ°ã€‚"
  ];
  return msgs[Math.floor(Math.random()*msgs.length)];
}

/** ========== æ›´æ–° UIï¼ˆA+Bï¼‰ ========== */
function updateUI(){
  if(!currPos) return;

  const home = settings.home;
  if(!home?.lat || !home?.lng){
    setStatus("è«‹å…ˆè¨­å®šä½å®¶ä½ç½®", "warn");
    dirEl.textContent = "è«‹é» âš™ï¸ è¨­å®š";
    return;
  }

  // é¡¯ç¤ºè·é›¢åˆ°å®¶ï¼ˆä»ä¿ç•™Açš„å®‰å¿ƒæ„Ÿï¼‰
  const distHome = Math.round(distanceMeters(currPos, home));
  distEl.textContent = `${distHome} å…¬å°º`;

  // è‹¥æœ‰è·¯ç·šï¼Œç®­é ­æŒ‡å‘ã€Œä¸‹ä¸€ç¯€é»ã€
  let target = null;
  if(route){
    target = getNextManeuverTarget(route);
  }

  if(target){
    const distToTurn = Math.round(distanceMeters(currPos, {lat:target.lat, lng:target.lng}));
    // è½‰å½æç¤ºï¼šæ¥è¿‘æ‰èªªï¼ˆä¾‹å¦‚ 25m å…§ï¼‰
    if(distToTurn <= 25){
      const say = friendlyTurnText(target.mod);
      dirEl.textContent = say.replace("ç­‰ä¸€ä¸‹",""); // åªé¡¯ç¤ºã€Œå·¦è½‰/å³è½‰/ç›´èµ°ã€
      speak(say, true);
    }else{
      dirEl.textContent = "è·Ÿè‘—ç®­é ­èµ°";
    }

    // ç®­é ­æ–¹å‘ï¼šæŒ‡å‘ä¸‹ä¸€ç¯€é»ï¼ˆåƒçœŸæ­£å°èˆªï¼‰
    const br = bearingDeg(currPos, {lat:target.lat, lng:target.lng});
    if(deviceHeading != null){
      const rel = normRel(br - deviceHeading);
      rotateArrow(rel);
    }else{
      rotateArrow(br); // fallbackï¼šä»å¯ç”¨ä½†ä¸å¦‚æœ‰headingç›´è¦º
    }

    // è‹¥å·²æ¥è¿‘è©²ç¯€é»ï¼Œæ¨é€²åˆ°ä¸‹ä¸€å€‹ step
    if(distToTurn <= 10 && route.nextIdx < route.steps.length-1){
      route.nextIdx += 1;
    }

    hintEl.textContent = `ä¸‹ä¸€å€‹ç¯€é»ç´„ ${distToTurn} å…¬å°º`;
  }else{
    // æ²’è·¯ç·šï¼šé€€åŒ–ç‚ºç›´æ¥æŒ‡å‘å®¶
    const br = bearingDeg(currPos, home);
    if(deviceHeading != null){
      rotateArrow(normRel(br - deviceHeading));
    }else{
      rotateArrow(br);
    }
    dirEl.textContent = "è«‹æœç®­é ­èµ°";
    hintEl.textContent = "ï¼ˆå°šæœªå–å¾—è·¯ç·šç¯€é»ï¼‰";
  }

  // åé›¢åµæ¸¬ï¼šè·é›¢åˆ°è·¯ç·š > é–€æª»ï¼Œå°±æé†’ + é‡æ–°è¦åŠƒ
  if(route?.line?.length){
    const dLine = metersToPolyline(currPos, route.line);
    if(dLine > 25){
      offRouteCount += 1;
    }else{
      offRouteCount = Math.max(0, offRouteCount-1);
    }

    if(offRouteCount >= 3){
      setStatus("åé›¢è·¯ç·š", "warn");
      vibrate([200,100,200,100,300]);
      speak(offRouteMessage(), true);
      offRouteCount = 0;

      // è‡ªå‹•é‡æ–°è¦åŠƒï¼ˆé¿å…ä¸€ç›´æ‰“APIï¼Œåšç¯€æµï¼‰
      const now = Date.now();
      if(now - lastReRouteAt > 15000){
        lastReRouteAt = now;
        reRoute(true);
      }
    }else{
      setStatus("æ­£åœ¨å¼•å°å›å®¶");
    }
  }else{
    setStatus("æ­£åœ¨å¼•å°å›å®¶");
  }

  dbgEl.textContent = `GPS: ${currPos.lat.toFixed(5)},${currPos.lng.toFixed(5)} | Heading: ${deviceHeading==null?"--":Math.round(deviceHeading)+"Â°"} | Route: ${route ? "OK" : "--"}`;
}

/** ========== å®šä½ç›£çœ‹ ========== */
function startWatch(){
  if(!navigator.geolocation){
    alert("æ­¤è£ç½®ä¸æ”¯æ´å®šä½");
    return;
  }
  if(watchId != null) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      currPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      updateUI();
    },
    (err) => {
      setStatus("å®šä½å¤±æ•—", "danger");
      alert("å®šä½å¤±æ•—ï¼šè«‹ç¢ºèªå·²å…è¨±å®šä½æ¬Šé™ï¼Œä¸¦åœ¨æˆ¶å¤–æ¸¬è©¦");
    },
    { enableHighAccuracy: true, maximumAge: 800, timeout: 15000 }
  );
}

/** ========== iOS/Android æ–¹å‘æ„Ÿæ¸¬ ========== */
async function requestMotionPermission(){
  try{
    if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function"){
      const res = await DeviceOrientationEvent.requestPermission();
      if(res !== "granted") throw new Error("not granted");
    }
    setStatus("æ„Ÿæ¸¬å¯ç”¨");
  }catch(e){
    setStatus("æ„Ÿæ¸¬æœªå…è¨±", "warn");
    alert("è«‹å…è¨±ã€å‹•ä½œèˆ‡æ–¹å‘ã€ï¼Œç®­é ­æœƒæ›´æº–ã€‚");
  }
}
function onDeviceOrientation(e){
  // iOS
  if(typeof e.webkitCompassHeading === "number"){
    deviceHeading = e.webkitCompassHeading;
    return;
  }
  // others
  if(typeof e.alpha === "number"){
    deviceHeading = (360 - e.alpha) % 360;
  }
}
window.addEventListener("deviceorientation", onDeviceOrientation, true);

/** ========== åœ°ç†ç·¨ç¢¼ï¼ˆåœ°å€â†’åº§æ¨™ï¼ŒåŸå‹ç”¨ï¼‰ ========== */
async function geocodeByNominatim(addr){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`;
  const r = await fetch(url, { headers: { "Accept": "application/json" } });
  if(!r.ok) throw new Error("geocode failed");
  const arr = await r.json();
  if(!arr?.length) throw new Error("not found");
  return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon) };
}

/** ========== é‡æ–°è¦åŠƒ ========== */
async function reRoute(silent=false){
  const home = settings.home;
  if(!currPos || !home?.lat || !home?.lng){
    if(!silent) alert("è«‹å…ˆå–å¾—å®šä½ä¸¦è¨­å®šä½å®¶ä½ç½®");
    return;
  }
  try{
    setStatus("è·¯ç·šè¦åŠƒä¸­...");
    route = await fetchRoute(currPos, home);
    route.nextIdx = 0;
    setStatus("æ­£åœ¨å¼•å°å›å®¶");
    if(!silent) speak("å·²æ›´æ–°è·¯ç·š", true);
    updateUI();
  }catch(e){
    setStatus("è·¯ç·šå¤±æ•—", "danger");
    if(!silent) alert("è·¯ç·šå–å¾—å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ–æœå‹™é™åˆ¶ï¼‰ã€‚");
  }
}

/** ========== æ±‚åŠ©ï¼šæ’¥è™Ÿ + è¨Šæ¯/WhatsAppåˆ†äº«å®šä½é€£çµ ========== */
function getMapsLink(pos){
  return `https://www.google.com/maps?q=${pos.lat},${pos.lng}`;
}
function sos(){
  const phone = (settings.familyPhone || "").trim();
  if(!currPos){
    alert("å°šæœªå–å¾—å®šä½ï¼Œè«‹ç¨ç­‰");
    return;
  }
  const link = getMapsLink(currPos);
  const msg = `æˆ‘éœ€è¦å”åŠ©ï¼Œæˆ‘çš„ä½ç½®ï¼š${link}`;

  // 1) æ’¥è™Ÿ
  if(phone){
    window.location.href = `tel:${phone}`;
  }

  // 2) è®“ä½¿ç”¨è€…å¯é¸åˆ†äº«ï¼šSMSï¼ˆiOS/Androidæ”¯æ´æƒ…æ³ä¸åŒï¼‰
  // iOS å¸¸ç”¨ï¼šsms:phone&body=...
  // Android å¸¸ç”¨ï¼šsms:phone?body=...
  const smsUrl = phone
    ? `sms:${phone}?&body=${encodeURIComponent(msg)}`
    : `sms:?&body=${encodeURIComponent(msg)}`;
  window.open(smsUrl, "_blank");

  // 3) WhatsApp åˆ†äº«ï¼ˆè‹¥å®‰è£ï¼‰
  const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, "_blank");
}

/** ========== è¨­å®šé¢æ¿ï¼ˆPINé–ï¼‰ ========== */
function openSettings(){
  const pin = prompt("è«‹è¼¸å…¥ PINï¼ˆé è¨­ 1234ï¼‰");
  if(pin == null) return;
  const ok = (pin.trim() || DEFAULT_PIN) === (settings.pin || DEFAULT_PIN);
  if(!ok){
    alert("PIN éŒ¯èª¤");
    return;
  }

  // å¡«å…¥ç›®å‰è¨­å®š
  $("pinInput").value = settings.pin || DEFAULT_PIN;
  $("familyPhone").value = settings.familyPhone || "";
  $("homeAddr").value = settings.homeAddr || "";
  $("homeLat").value = settings.home?.lat ?? "";
  $("homeLng").value = settings.home?.lng ?? "";

  panel.style.display = "block";
}
function closeSettings(){
  panel.style.display = "none";
}
async function saveSettingsFromUI(){
  const newPin = ($("pinInput").value || DEFAULT_PIN).trim();
  if(newPin.length !== 4 || !/^\d{4}$/.test(newPin)){
    alert("PIN å¿…é ˆæ˜¯ 4 ä½æ•¸å­—");
    return;
  }

  const phone = $("familyPhone").value.trim();
  const addr  = $("homeAddr").value.trim();
  let lat = parseFloat($("homeLat").value);
  let lng = parseFloat($("homeLng").value);

  // è‹¥æ²’å¡«ç¶“ç·¯åº¦ä½†æœ‰åœ°å€ï¼Œå°±å˜—è©¦åœ°ç†ç·¨ç¢¼
  if((!isFinite(lat) || !isFinite(lng)) && addr){
    try{
      setStatus("æ­£åœ¨æŸ¥è©¢åœ°å€...");
      const p = await geocodeByNominatim(addr);
      lat = p.lat; lng = p.lng;
      $("homeLat").value = lat;
      $("homeLng").value = lng;
    }catch(e){
      alert("åœ°å€æŸ¥è©¢å¤±æ•—ã€‚å»ºè­°ç›´æ¥å¡«ç¶“ç·¯åº¦ï¼ˆæœ€ç©©ï¼‰ã€‚");
      return;
    }
  }

  if(!isFinite(lat) || !isFinite(lng)){
    alert("è«‹å¡«ä½å®¶ç¶“ç·¯åº¦ï¼Œæˆ–å¡«åœ°å€è®“ç³»çµ±æŸ¥è©¢");
    return;
  }

  settings = {
    pin: newPin,
    familyPhone: phone,
    homeAddr: addr,
    home: { lat, lng }
  };
  saveSettings(settings);
  setStatus("å·²å„²å­˜è¨­å®š");
  closeSettings();

  // æœ‰å®šä½æ™‚å¯ç›´æ¥é‡æ–°è¦åŠƒ
  if(currPos) await reRoute(true);
  updateUI();
}

/** ========== Buttons ========== */
$("btnPerm").addEventListener("click", requestMotionPermission);

$("btnMute").addEventListener("click", () => {
  mute = !mute;
  $("btnMute").textContent = `èªéŸ³ï¼š${mute ? "é—œ" : "é–‹"}`;
  if(!mute) speak("èªéŸ³å·²é–‹å•Ÿ", true);
});

$("btnStart").addEventListener("click", async () => {
  navOn = true;
  setStatus("é–‹å§‹å¼•å°");
  speak("é–‹å§‹å›å®¶", true);
  startWatch();
  // ç­‰æœ‰å®šä½å¾Œå†æŠ“è·¯ç·š
  setTimeout(() => reRoute(true), 1200);
});

$("btnReRoute").addEventListener("click", () => reRoute(false));
$("btnSOS").addEventListener("click", sos);
$("btnSettings").addEventListener("click", openSettings);
$("btnCloseSettings").addEventListener("click", closeSettings);
$("btnSaveSettings").addEventListener("click", saveSettingsFromUI);

// init
setStatus("å…ˆè¨­å®šä½å®¶ä½ç½®", "warn");
updateUI();
</script>
</body>
</html>
